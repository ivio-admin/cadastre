<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Búsqueda RC + GetFeatureInfo Catastro</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;margin:16px}
  .row{display:flex;gap:8px;align-items:center}
  input{flex:1;padding:8px 10px;border:1px solid #ccc;border-radius:8px}
  button{padding:8px 12px;border:0;border-radius:8px;background:#1f6feb;color:#fff;cursor:pointer}
  #estado{margin-top:10px;color:#555}
  #resumen{margin-top:12px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa;display:none}
  #html{margin-top:8px;border:1px dashed #ddd;padding:10px;border-radius:8px;background:#fff;max-height:360px;overflow:auto}
</style>

<h3>Búsqueda por Referencia Catastral (RC)</h3>
<div class="row">
  <input id="refcat" type="text" placeholder="Ej: 1234567AB1234C0001DE" pattern="[A-Za-z0-9]{14,25}" required>
  <button id="btnBuscar">Buscar</button>
</div>
<div id="estado"></div>
<div id="resumen"></div>
<details style="margin-top:10px">
  <summary>Ver respuesta completa GetFeatureInfo (HTML)</summary>
  <div id="html"></div>
</details>

<script>
(function(){
  const useProxy = true; // activa proxy si CORS falla
  const proxy = 'https://thingproxy.freeboard.io/fetch/';

  const wrap = url => useProxy ? (proxy + encodeURI(url)) : url;
  const btn = document.getElementById('btnBuscar');
  const inp = document.getElementById('refcat');
  const estado = document.getElementById('estado');
  const htmlDiv = document.getElementById('html');
  const resumenDiv = document.getElementById('resumen');
  const setEstado = t => estado.textContent = t || '';

  async function fetchText(url){
    const res = await fetch(wrap(url));
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.text();
  }

  function parseXY(xml){
    const x = (xml.match(/<xcen>(.*?)<\/xcen>/i)||[])[1];
    const y = (xml.match(/<ycen>(.*?)<\/ycen>/i)||[])[1];
    return (x&&y)?{x:parseFloat(x),y:parseFloat(y)}:null;
  }

  function extractSummaryFromHTML(html){
    const div = document.createElement('div'); div.innerHTML = html;
    const text = div.textContent || '';
    const mRC = text.match(/(RC|Referencia(?:\s+)?Catastral|nationalCadastralReference)\s*[:=]?\s*([A-Z0-9\-\.]{10,25})/i);
    const mMuni = text.match(/(Municipio|Municipality|locality)\s*[:=]\s*([A-ZÁÉÍÓÚÜÑa-záéíóúüñ\.\-\s]+)/);
    const mSup = text.match(/(Área|Superficie|Area)\s*[:=]\s*([\d\.,]+\s*(m²|m2)?)/i);
    let out='';
    if(mRC) out+=`<div><b>RC:</b> ${mRC
