<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RC + GetFeatureInfo (Catastro)</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;margin:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:8px;align-items:center}
  input{padding:8px 10px;border:1px solid #ccc;border-radius:8px}
  button{padding:8px 12px;border:0;border-radius:8px;background:#1f6feb;color:#fff;cursor:pointer}
  #estado{margin-top:10px;color:#555}
  #resumen{margin-top:12px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa;display:none}
  #html{margin-top:8px;border:1px dashed #ddd;padding:10px;border-radius:8px;background:#fff;max-height:360px;overflow:auto}
  #debug{margin-top:10px;font:12px/1.3 monospace;color:#666;white-space:pre-wrap}
</style>

<h3>Búsqueda por Referencia Catastral (RC):</h3>
<div class="grid">
  <input id="prov" placeholder="Provincia (opcional) - p.ej. Lleida">
  <input id="muni" placeholder="Municipio (opcional) - p.ej. Almenar">
  <input id="refcat" placeholder="RC (14 o 20) - p.ej. 25057A00500045" pattern="[A-Za-z0-9]{10,25}" required>
  <button id="btnBuscar">Buscar</button>
</div>
<div id="estado"></div>
<div id="resumen"></div>
<details style="margin-top:10px">
  <summary>Ver respuesta completa GetFeatureInfo (HTML)</summary>
  <div id="html"></div>
</details>
<details>
  <summary>Depuración</summary>
  <div id="debug"></div>
</details>

<script>
(function(){
  // === Pega aquí tu proxy de Cloudflare Worker (acaba en ?url=). Deja fallback si aún no lo tienes ===
  const myWorkerProxy = 'https://ivio.irodriguezdiputacio.workers.dev/?url='; // ej: 'https://tu-proxy.worker.dev/?url='
  const fallbackProxy  = 'https://thingproxy.freeboard.io/fetch/'; // solo pruebas
  const proxy = (myWorkerProxy || fallbackProxy);
  const wrap  = url => proxy + encodeURIComponent(url);

  const q = id => document.getElementById(id);
  const estado = q('estado'), htmlDiv = q('html'), resumenDiv = q('resumen'), debugDiv = q('debug');

  const setEstado = t => estado.textContent = t || '';

  async function fetchText(url){
    const res = await fetch(wrap(url));
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.text();
  }

  function tryParseXY(xml){
    const x = (xml.match(/<xcen>(.*?)<\/xcen>/i)||[])[1];
    const y = (xml.match(/<ycen>(.*?)<\/ycen>/i)||[])[1];
    if(x && y) return { x: parseFloat(x), y: parseFloat(y) };
    return null;
  }

  async function getXYfromRC(rc, prov, muni){
    const tried = [];

    // 1) DNPRC (ASMX) con Provincia/Municipio si están informados
    if (prov || muni) {
      try {
        const u = `https://ovc.catastro.meh.es/OVCServWeb/OVCSWLocalizacionRC/OVCSWLocalizacionRC.asmx/Consulta_DNPRC?Provincia=${encodeURIComponent(prov||'')}&Municipio=${encodeURIComponent(muni||'')}&RC=${encodeURIComponent(rc)}`;
        tried.push(u);
        const xml = await fetchText(u);
        const xy = tryParseXY(xml);
        if (xy) return {xy, used: u};
      } catch(e){}
    }

    // 2) DNPRC (WCF)
    try{
      const u = `https://ovc.catastro.meh.es/OVCServWeb/OVCWcfCallejero/COVCCallejero.svc/Consulta_DNPRC?RC=${encodeURIComponent(rc)}`;
      tried.push(u);
      const xml = await fetchText(u);
      const xy = tryParseXY(xml);
      if(xy) return {xy, used:u};
    }catch(e){}

    // 3) DNPRC (ASMX) sin provincia/municipio
    try{
      const u = `https://ovc.catastro.meh.es/OVCServWeb/OVCSWLocalizacionRC/OVCSWLocalizacionRC.asmx/Consulta_DNPRC?Provincia=&Municipio=&RC=${encodeURIComponent(rc)}`;
      tried.push(u);
      const xml = await fetchText(u);
      const xy = tryParseXY(xml);
      if(xy) return {xy, used:u};
    }catch(e){}

    // 4) RCCOOR (ASMX) con Provincia/Municipio si están informados
    if (prov || muni) {
      try{
        const u = `https://ovc.catastro.meh.es/OVCServWeb/OVCSWLocalizacionRC/OVCSWLocalizacionRC.asmx/Consulta_RCCOOR?Provincia=${encodeURIComponent(prov||'')}&Municipio=${encodeURIComponent(muni||'')}&RC=${encodeURIComponent(rc)}&SRS=EPSG:4258`;
        tried.push(u);
        const xml = await fetchText(u);
        const xy = tryParseXY(xml);
        if(xy) return {xy, used:u};
      }catch(e){}
    }

    // 5) RCCOOR (ASMX) sin provincia/municipio (a veces no devuelve nada para 14)
    try{
      const u = `https://ovc.catastro.meh.es/OVCServWeb/OVCSWLocalizacionRC/OVCSWLocalizacionRC.asmx/Consulta_RCCOOR?RC=${encodeURIComponent(rc)}&SRS=EPSG:4258`;
      tried.push(u);
      const xml = await fetchText(u);
      const xy = tryParseXY(xml);
      if(xy) return {xy, used:u};
    }catch(e){}

    return {xy:null, tried};
  }

  function extractSummaryFromHTML(html){
    const div = document.createElement('div'); div.innerHTML = html;
    const text = div.textContent || '';
    const mRC = text.match(/(RC|Referencia(?:\s+)?Catastral|nationalCadastralReference)\s*[:=]?\s*([A-Z0-9\-\.]{10,25})/i);
    const mMuni = text.match(/(Municipio|Municipality|locality)\s*[:=]\s*([A-ZÁÉÍÓÚÜÑa-záéíóúüñ\.\-\s]+)/);
    const mSup = text.match(/(Área|Superficie|Area)\s*[:=]\s*([\d\.,]+\s*(m²|m2)?)/i);
    let out='';
    if(mRC) out+=`<div><b>RC:</b> ${mRC[2]}</div>`;
    if(mMuni) out+=`<div><b>Municipio:</b> ${mMuni[2].trim()}</div>`;
    if(mSup) out+=`<div><b>Superficie:</b> ${mSup[2]}</div>`;
    return out;
  }

  async function buscar(){
    const rc = (q('refcat').value||'').trim();
    const prov = (q('prov').value||'').trim();
    const muni = (q('muni').value||'').trim();

    if(!rc){ setEstado('Introduce una referencia catastral.'); return; }

    htmlDiv.innerHTML=''; resumenDiv.style.display='none'; debugDiv.textContent='';
    setEstado('Localizando coordenadas…');

    try{
      const loc = await getXYfromRC(rc, prov, muni);
      if(!loc.xy){
        setEstado('No se han obtenido coordenadas para esa RC. Prueba indicando Provincia y Municipio.');
        debugDiv.textContent = 'Endpoints probados:\n' + (loc.tried||[]).join('\n');
        return;
      }

      const { x, y } = loc.xy; // lon,lat (ETRS89)
      const delta=0.0004; // ~40 m
      const minx=(x-delta).toFixed(6), miny=(y-delta).toFixed(6);
      const maxx=(x+delta).toFixed(6), maxy=(y+delta).toFixed(6);

      setEstado('Consultando WMS GetFeatureInfo…');
      const wmsBase='https://ovc.catastro.meh.es/cartografia/INSPIRE/spadgcwms.aspx';
      const params=new URLSearchParams({
        SERVICE:'WMS',
        VERSION:'1.1.1', // orden lon,lat
        REQUEST:'GetFeatureInfo',
        LAYERS:'CP.CadastralParcel',
        QUERY_LAYERS:'CP.CadastralParcel',
        SRS:'EPSG:4258',
        BBOX:`${minx},${miny},${maxx},${maxy}`,
        WIDTH:'101',
        HEIGHT:'101',
        X:'50',
        Y:'50',
        INFO_FORMAT:'text/html'
      });
      const wmsUrl = `${wmsBase}?${params.toString()}`;
      const html = await fetchText(wmsUrl);

      htmlDiv.innerHTML = html || '(Sin contenido)';
      const resumen = extractSummaryFromHTML(html);
      if(resumen){ resumenDiv.innerHTML = `<b>Resumen</b><br>${resumen}`; resumenDiv.style.display='block'; }

      setEstado(`RC localizada en (${x.toFixed(6)}, ${y.toFixed(6)}).`);
      debugDiv.textContent = [
        prov||muni ? `Se usó Provincia/Municipio: ${prov} / ${muni}` : 'Provincia/Municipio no informados',
        '',
        'Localizador usado:',
        (loc.used || '(no capturado)'),
        '',
        'URL GetFeatureInfo:',
        wmsUrl
      ].join('\n');
    }catch(e){
      console.error(e);
      setEstado('Error en la consulta (proxy/CORS o servicio no disponible).');
    }
  }

  document.getElementById('btnBuscar').addEventListener('click',buscar);
  document.getElementById('refcat').addEventListener('keydown',e=>{ if(e.key==='Enter') buscar(); });
})();
</script>
</html>
