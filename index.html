<!doctype html>
<meta charset="utf-8">
<title>RC + GetFeatureInfo (Catastro)</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;margin:16px}
  .row{display:flex;gap:8px;align-items:center}
  input{flex:1;padding:8px 10px;border:1px solid #ccc;border-radius:8px}
  button{padding:8px 12px;border:0;border-radius:8px;background:#1f6feb;color:#fff;cursor:pointer}
  #estado{margin-top:10px;color:#555}
  #resumen{margin-top:12px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa;display:none}
  #html{margin-top:8px;border:1px dashed #ddd;padding:10px;border-radius:8px;background:#fff;max-height:360px;overflow:auto}
</style>

<h3>Búsqueda por Referencia Catastral (RC)</h3>
<div class="row">
  <input id="refcat" type="text" placeholder="Ej: 1234567AB1234C0001DE" pattern="[A-Za-z0-9]{14,25}" required>
  <button id="btnBuscar">Buscar</button>
</div>
<div id="estado"></div>
<div id="resumen"></div>
<details style="margin-top:10px">
  <summary>Ver respuesta completa GetFeatureInfo (HTML)</summary>
  <div id="html"></div>
</details>

<script>
(function(){
  // Cambia a true si ves errores CORS en la consola
  const useProxy = false;
  const proxy = 'https://thingproxy.freeboard.io/fetch/'; // demo. Para producción: tu propio proxy.

  const btn = document.getElementById('btnBuscar');
  const inp = document.getElementById('refcat');
  const estado = document.getElementById('estado');
  const htmlDiv = document.getElementById('html');
  const resumenDiv = document.getElementById('resumen');

  const wrap = url => useProxy ? (proxy + encodeURI(url)) : url;
  const setEstado = t => estado.textContent = t || '';

  async function fetchText(url){
    const res = await fetch(wrap(url));
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.text();
  }

  function parseXY(xml){
    const x = (xml.match(/<xcen>(.*?)<\/xcen>/i)||[])[1];
    const y = (xml.match(/<ycen>(.*?)<\/ycen>/i)||[])[1];
    return (x&&y)?{x:parseFloat(x),y:parseFloat(y)}:null;
  }

  function extractSummaryFromHTML(html){
    const div = document.createElement('div'); div.innerHTML = html;
    const text = div.textContent || '';
    const mRC = text.match(/(RC|Referencia(?:\s+)?Catastral|nationalCadastralReference)\s*[:=]?\s*([A-Z0-9\-\.]{10,25})/i);
    const mMuni = text.match(/(Municipio|Municipality|locality)\s*[:=]\s*([A-ZÁÉÍÓÚÜÑa-záéíóúüñ\.\-\s]+)/);
    const mSup = text.match(/(Área|Superficie|Area)\s*[:=]\s*([\d\.,]+\s*(m²|m2)?)/i);
    let out='';
    if(mRC) out+=`<div><b>RC:</b> ${mRC[2]}</div>`;
    if(mMuni) out+=`<div><b>Municipio:</b> ${mMuni[2].trim()}</div>`;
    if(mSup) out+=`<div><b>Superficie:</b> ${mSup[2]}</div>`;
    return out;
  }

  async function buscar(){
    const rc = (inp.value||'').trim();
    if(!rc){ setEstado('Introduce una referencia catastral.'); return; }
    htmlDiv.innerHTML=''; resumenDiv.style.display='none'; setEstado('Localizando coordenadas…');

    try{
      // 1) Coordenadas por RC (centroide ETRS89)
      const urlCoords = 'https://ovc.catastro.meh.es/OVCServWeb/OVCWcfCallejero/COVCCallejero.svc/Consulta_DNPRC?RC='
                        + encodeURIComponent(rc);
      const xml = await fetchText(urlCoords);
      const xy = parseXY(xml);
      if(!xy){ setEstado('No se han obtenido coordenadas para esa RC.'); return; }

      // 2) BBOX alrededor del punto (CRS=EPSG:4258)
      const delta=0.0003;
      const minx=(xy.x-delta).toFixed(6), miny=(xy.y-delta).toFixed(6);
      const maxx=(xy.x+delta).toFixed(6), maxy=(xy.y+delta).toFixed(6);

      // 3) GetFeatureInfo WMS
      setEstado('Consultando WMS GetFeatureInfo…');
      const wmsBase='https://ovc.catastro.meh.es/cartografia/INSPIRE/spadgcwms.aspx';
      const params=new URLSearchParams({
        SERVICE:'WMS', VERSION:'1.3.0', REQUEST:'GetFeatureInfo',
        LAYERS:'CP.CadastralParcel', QUERY_LAYERS:'CP.CadastralParcel',
        CRS:'EPSG:4258', BBOX:`${minx},${miny},${maxx},${maxy}`,
        WIDTH:'101', HEIGHT:'101', I:'50', J:'50', INFO_FORMAT:'text/html'
      });
      const html = await fetchText(`${wmsBase}?${params.toString()}`);

      htmlDiv.innerHTML = html || '(Sin contenido)';
      const resumen = extractSummaryFromHTML(html);
      if(resumen){ resumenDiv.innerHTML = `<b>Resumen</b><br>${resumen}`; resumenDiv.style.display='block'; }
      setEstado(`RC localizada en (${xy.x.toFixed(6)}, ${xy.y.toFixed(6)}).`);

      // Aviso a app padre (Experience Builder) para centrar el mapa si quieres
      try{ parent.postMessage({type:'catastro_rc_location',rc,x:xy.x,y:xy.y}, '*'); }catch(e){}
    }catch(e){
      console.error(e);
      setEstado('Error en la consulta (CORS o servicio no disponible). Prueba activar el proxy en el código.');
    }
  }

  btn.addEventListener('click',buscar);
  inp.addEventListener('keydown',e=>{ if(e.key==='Enter') buscar(); });
})();
</script>
